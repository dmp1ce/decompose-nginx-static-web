# Include common processes
source $(_decompose-project-root)/.decompose/environment/lib/web/processes
source $(_decompose-project-root)/.decompose/environment/lib/common/processes
source $(_decompose-project-root)/.decompose/environment/lib/backup/processes

DECOMPOSE_PROCESSES=( 'build' 'up'
  "${DECOMPOSE_WEB_PROCESSES[@]}" "${DECOMPOSE_COMMON_PROCESSES[@]}"
  "${DECOMPOSE_BACKUP_PROCESSES[@]}" )

_decompose-process-build() {
  echo "Building decompose templates..."
  decompose-process-templates

  echo "Creating version file..."
  local project_root=$(_decompose-project-root)
  local git_base_revision="`git -C $project_root describe --tags --match=v* --always --dirty 2>&1`"
  # Set current base version
  echo -e "$PROJECT_ENVIRONMENT\n$git_base_revision" > \
    "$project_root"/"$PROJECT_VERSION_FILE"

  # Pull the latest images
  # Waiting for docker-compose fix:
  # https://github.com/docker/compose/pull/1494
  echo "Updating docker images..."
  docker pull busybox
  docker pull nginx
  docker pull jwilder/nginx-proxy

  # Remove 'source' container if this is production
  echo "Rebuilding/recreating all containers..."
  if [[ $PRODUCTION ]]; then
    docker-compose stop web
    docker-compose rm -f web
    docker-compose build
    docker-compose up -d
  else
    docker-compose build
  fi
}
_decompose-process-build_help() {
  echo "  Build the project"
}

_decompose-process-up() {
  if [[ $PRODUCTION ]]; then
    docker-compose up -d --force-recreate
  else
    docker-compose up -d
  fi

  # Restart nginx-proxy
  _decompose-process-restart_nginx_proxy
}
_decompose-process-up_help() {
  echo "  Start project locally"
}

# vim:syntax=sh
